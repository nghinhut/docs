@startuml
title IdM Encryption Function
participant "IdM Service" as idm
participant "Encryption Service" as es
actor "Security Admin" as esAdmin

es <- esAdmin : create a key with key name (Ex: keyname: 'idm-key01') (anytime)

idm ->> idm : encrypted1 = serviceEncrypt('chacha20-poly1305', $text, $serviceKey)
note left
    serviceKey is a random string secret
    generated by Service's Maintainer/Admin
    and pass though environment variable at runtime
end note

idm ->> idm : encrypted2 = externalEncrypt(encrypted1)
activate idm
    idm ->> es : request encrypt with keyname = 'idm-key01'
        es -> es : encrypt([[https://www.vaultproject.io/docs/secrets/transit/index.html#chacha20-poly1305{ChaCha20-Poly1305 with a 256-bit key} 'ChaCha20-Poly1305']], $text //<encrypted>//, $masterKey)
        note right
            master key are private at Encryption Service
            only Security Admin has access.
            ...
            POST /transit/encrypt/:name

            [[https://www.vaultproject.io/api/secret/transit/index.html#encrypt-data ref: Encrypt Data API]]
        end note
    idm <<-- es : return encrypted string (encrypted2 value)
deactivate idm
@enduml